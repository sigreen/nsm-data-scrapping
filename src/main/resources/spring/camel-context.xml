<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:camel-cxf="http://camel.apache.org/schema/cxf" xmlns:camel="http://camel.apache.org/schema/spring"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
			        http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
			        http://camel.apache.org/schema/cxf http://camel.apache.org/schema/cxf/camel-cxf.xsd">
	<camelContext id="camel" xmlns="http://camel.apache.org/schema/spring">
		<endpoint id="NSMtoCIP"
			uri="dozer:NSMtoCIP?sourceModel=generated_1506187282094.Policy&amp;targetModel=generated_1506187282978.Policies&amp;marshalId=generated_1506187282978&amp;unmarshalId=generated_1506187282094&amp;mappingFile=transformation.xml" />
		<dataFormats>
			<jaxb contextPath="generated_1506187282094" id="generated_1506187282094" />
			<jaxb contextPath="generated_1506187282978" id="generated_1506187282978" />
		</dataFormats>
		<route id="pull-nsm-file">
			<from id="sftp-pull"
				uri="sftp://{{sftp.host}}:{{sftp.port}}/Users/Shared/sftp/?username={{sftp.user}}&amp;password={{sftp.password}}&amp;move=.done&amp;moveFailed=.error" />
			<convertBodyTo id="_convertBodyTo1" type="java.lang.String" />
			<split id="_split1">
				<xpath>/Policies/Policy</xpath>
				<to id="_to1" uri="amq:incomingMessageChannel" />
			</split>
		</route>
		<route id="validate-enrich-message">
			<from id="_from1" uri="amq:incomingMessageChannel" />
			<onException id="_onException1" useOriginalMessage="true">
				<exception>org.apache.camel.ValidationException</exception>
				<handled>
					<constant>true</constant>
				</handled>
				<log id="_log1"
					message="Policy is invalid.  Error is ${exception.message}. Message contents: ${body}" />
				<setHeader headerName="errorMessage" id="_setHeader2">
					<simple>${exception.message}</simple>
				</setHeader>
				<inOnly id="_inOnly1" uri="activemq:incomingMessageErrors" />
			</onException>
			<to id="_to2" uri="validator:schema/nsm-policy.xsd" />
			<to id="_to3" uri="xslt:stylesheet/messageEnrichment.xslt" />
			<to id="_to4" uri="amq:enrichedMessageChannel" />
			<to
				uri="sql:INSERT INTO NSM_MESSAGE_STORE (BATCH_ID, FILE_ID, MESSAGE, PROCESSED) VALUES(:#breadcrumbId, :#CamelFileRelativePath, :#${body}, false);" />
		</route>
		<route id="message-transformation">
			<from
				uri="sql:SELECT * FROM NSM_MESSAGE_STORE WHERE PROCESSED=false?onConsume=UPDATE NSM_MESSAGE_STORE set PROCESSED = true where MESSAGE_ID = :#MESSAGE_ID" />
			<split>
				<simple>${body}</simple>
				<setHeader headerName="batchID">
					<simple>
						${body[BATCH_ID]}
					</simple>
				</setHeader>
				<setHeader headerName="fileID">
					<simple>
						${body[FILE_ID]}
					</simple>
				</setHeader>
				<setBody>
					<simple>
						${body[MESSAGE]}
					</simple>
				</setBody>
				<to uri="ref:NSMtoCIP" />
				<to uri="amq:formattedMessageChannel" />
				<to
					uri="sql:INSERT INTO CIP_MESSAGE_STORE (BATCH_ID, FILE_ID, MESSAGE, PROCESSED) VALUES(:#batchID, :#fileID, :#${body}, false);" />
			</split>
		</route>
		<route id="message-resequencer">
			<from
				uri="sql:select * from CIP_MESSAGE_STORE WHERE BATCH_ID = (select BATCH_ID from CIP_MESSAGE_STORE WHERE PROCESSED=false GROUP BY BATCH_ID LIMIT 1) ORDER BY MESSAGE_ID?onConsume=UPDATE CIP_MESSAGE_STORE set PROCESSED = true where MESSAGE_ID = :#MESSAGE_ID" />
			<split>
				<simple>${body}</simple>
				<setHeader headerName="batchID">
					<simple>
						${body[BATCH_ID]}
					</simple>
				</setHeader>
				<setHeader headerName="fileID">
					<simple>
						${body[FILE_ID]}
					</simple>
				</setHeader>
				<setHeader headerName="messageSqNum">
					<simple>
						${body[MESSAGE_ID]}
					</simple>
				</setHeader>
				<setBody>
					<simple>
						${body[MESSAGE]}
					</simple>
				</setBody>
				<to uri="amq:outgoingMessageChannel" />
			</split>
		</route>
		<route id="send-to-eis">
			<from uri="amq:outgoingMessageChannel" />
			<onException useOriginalMessage="true">
				<exception>javax.xml.soap.SOAPException</exception>
				<continued>
					<constant>true</constant>
				</continued>
				<log
					message="EIS connectivity error.  Error is ${exception.message}. Message contents: ${body}" />
				<setHeader headerName="errorMessage">
					<simple>${exception.message}</simple>
				</setHeader>
				<inOnly uri="activemq:outgoingErrorMessages" />
			</onException>
			<removeHeaders pattern="*"/>
			<convertBodyTo  type="java.lang.String" />
			<setHeader headerName="operationNamespace">
				<constant>http://www.example.org/Test/</constant>
			</setHeader>
			<setHeader headerName="operationName">
				<constant>putXml</constant>
			</setHeader>
			<to uri="cxf:bean:eisRequestClient" />
			<log
				message="Response Code: [${header.CamelCxfMessage[org.apache.cxf.message.Message.RESPONSE_CODE]}]" />
			<log message="Response Body: [${body}]" />
		</route>
	</camelContext>
</beans>
